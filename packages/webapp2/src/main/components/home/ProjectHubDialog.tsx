import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { toast } from 'react-toastify';
import {
  ArrowLeft,
  CalendarDays,
  FileSpreadsheet,
  FolderOpen,
  Plus,
  Sparkles,
  Trash2,
  Upload,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { BesserProject } from '../../types/project';
import { useProject } from '../../hooks/useProject';
import { ProjectStorageRepository } from '../../services/storage/ProjectStorageRepository';
import { importProject } from '../../services/import/useImportProject';
import { normalizeProjectName } from '../../utils/projectName';
import { BACKEND_URL } from '../../constant';
import { useImportDiagramToProject } from '../../services/import/useImportDiagram';

interface ProjectHubDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

type ProjectHubStep = 'start' | 'create' | 'import' | 'spreadsheet' | 'open';

const defaultForm = {
  name: 'New_Project',
  description: 'Modern workspace project for UML, GUI and quantum modeling.',
  owner: 'BESSER User',
};

const readableFileSize = (bytes: number): string => {
  if (bytes < 1024) {
    return `${bytes} B`;
  }
  if (bytes < 1024 * 1024) {
    return `${(bytes / 1024).toFixed(1)} KB`;
  }
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
};

export const ProjectHubDialog: React.FC<ProjectHubDialogProps> = ({ open, onOpenChange }) => {
  const [projects, setProjects] = useState<BesserProject[]>([]);
  const [step, setStep] = useState<ProjectHubStep>('start');
  const [form, setForm] = useState(defaultForm);
  const [spreadsheetForm, setSpreadsheetForm] = useState(defaultForm);
  const [spreadsheetFiles, setSpreadsheetFiles] = useState<File[]>([]);
  const [isBusy, setIsBusy] = useState(false);
  const importFileInputRef = useRef<HTMLInputElement | null>(null);
  const spreadsheetFileInputRef = useRef<HTMLInputElement | null>(null);

  const { currentProject, createProject, loadProject, deleteProject } = useProject();
  const importDiagramToProject = useImportDiagramToProject();
  const canClose = Boolean(currentProject);

  const refreshProjects = useCallback(() => {
    const all = ProjectStorageRepository.getAllProjects();
    const sorted = [...all].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
    setProjects(sorted as BesserProject[]);
  }, []);

  useEffect(() => {
    if (!open) {
      return;
    }
    refreshProjects();
    setStep('start');
    setForm(defaultForm);
    setSpreadsheetForm(defaultForm);
    setSpreadsheetFiles([]);
  }, [open, refreshProjects]);

  const currentStepInfo = useMemo(() => {
    if (step === 'create') {
      return {
        title: 'Create A Project',
        description: 'Define project metadata and start modeling from scratch.',
        badge: 'Step 2 of 2',
      };
    }
    if (step === 'import') {
      return {
        title: 'Import A Project',
        description: 'Load an exported project file and continue where you left off.',
        badge: 'Step 2 of 2',
      };
    }
    if (step === 'spreadsheet') {
      return {
        title: 'Start From Spreadsheet',
        description: 'Create a project and auto-generate a class diagram from CSV/XLSX files.',
        badge: 'Step 2 of 2',
      };
    }
    if (step === 'open') {
      return {
        title: 'Open Existing Project',
        description: 'Pick any saved project and re-enter your workspace instantly.',
        badge: 'Step 2 of 2',
      };
    }
    return {
      title: 'Welcome to the BESSER Web Modeling Editor',
      description: 'Choose how you want to start your modeling session and open your workspace.',
      badge: 'Step 1 of 2',
    };
  }, [step]);

  const handleDialogOpenChange = (nextOpen: boolean) => {
    if (!nextOpen && !canClose) {
      return;
    }
    onOpenChange(nextOpen);
  };

  const handleCreateProject = async () => {
    const name = normalizeProjectName(form.name);
    const description = form.description.trim();
    const owner = form.owner.trim();

    if (!name) {
      toast.error('Project name is required.');
      return;
    }

    try {
      setIsBusy(true);
      await createProject(name, description || defaultForm.description, owner || defaultForm.owner);
      refreshProjects();
      handleDialogOpenChange(false);
      toast.success(`Project "${name}" created.`);
    } catch (error) {
      toast.error(`Could not create project: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsBusy(false);
    }
  };

  const handleOpenProject = async (projectId: string) => {
    try {
      setIsBusy(true);
      await loadProject(projectId);
      handleDialogOpenChange(false);
      toast.success('Project loaded.');
    } catch (error) {
      toast.error(`Could not load project: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsBusy(false);
    }
  };

  const handleDeleteProject = async (projectId: string, projectName: string) => {
    try {
      setIsBusy(true);
      await deleteProject(projectId);
      refreshProjects();
      toast.success(`Deleted project "${projectName}".`);
    } catch (error) {
      toast.error(`Could not delete project: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsBusy(false);
    }
  };

  const handleImportProjectFile = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) {
      return;
    }

    try {
      setIsBusy(true);
      const importedProject = await importProject(file);
      await loadProject(importedProject.id);
      refreshProjects();
      handleDialogOpenChange(false);
      toast.success(`Imported project "${importedProject.name}".`);
    } catch (error) {
      toast.error(`Import failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsBusy(false);
      event.target.value = '';
    }
  };

  const handleSpreadsheetFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files ? Array.from(event.target.files) : [];
    setSpreadsheetFiles(files);
  };

  const handleStartFromSpreadsheet = async () => {
    const name = normalizeProjectName(spreadsheetForm.name);
    const description = spreadsheetForm.description.trim();
    const owner = spreadsheetForm.owner.trim();

    if (!name) {
      toast.error('Project name is required.');
      return;
    }

    if (spreadsheetFiles.length === 0) {
      toast.error('Select at least one CSV/XLSX file.');
      return;
    }

    try {
      setIsBusy(true);
      await createProject(name, description || defaultForm.description, owner || defaultForm.owner);

      const requestData = new FormData();
      spreadsheetFiles.forEach((file) => requestData.append('files', file));

      const response = await fetch(`${BACKEND_URL}/csv-to-domain-model`, {
        method: 'POST',
        body: requestData,
      });

      if (!response.ok) {
        let message = 'Could not generate class diagram from spreadsheet.';
        try {
          const errorData = await response.json();
          if (typeof errorData?.detail === 'string') {
            message = errorData.detail;
          }
        } catch {
          // Keep fallback message.
        }
        throw new Error(message);
      }

      const diagramJson = await response.json();
      const generatedDiagramFile = new File(
        [JSON.stringify(diagramJson)],
        `${name}_class_diagram.json`,
        { type: 'application/json' },
      );

      await importDiagramToProject(generatedDiagramFile);
      refreshProjects();
      handleDialogOpenChange(false);
      toast.success(`Project "${name}" created and class diagram imported.`);
    } catch (error) {
      toast.error(`Spreadsheet import failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsBusy(false);
    }
  };

  const renderProjectList = () => (
    <div className="space-y-3">
      {projects.length === 0 && (
        <Card className="border-dashed border-border/80 bg-muted/20 shadow-none">
          <CardContent className="py-6 text-sm text-muted-foreground">
            No projects yet. Create one to get started.
          </CardContent>
        </Card>
      )}

      {projects.map((project) => {
        const isCurrent = currentProject?.id === project.id;
        return (
          <Card key={project.id} className={isCurrent ? 'border-primary/40 bg-primary/5 shadow-none' : 'shadow-none'}>
            <CardContent className="space-y-3 p-4">
              <div className="flex items-start justify-between gap-3">
                <div className="min-w-0">
                  <p className="truncate text-sm font-semibold">{project.name}</p>
                  <p className="mt-1 text-xs text-muted-foreground">{project.description || 'No description provided.'}</p>
                </div>
                {isCurrent && <Badge>Active</Badge>}
              </div>

              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                <CalendarDays className="h-3.5 w-3.5" />
                <span>{new Date(project.createdAt).toLocaleString()}</span>
              </div>

              <div className="flex gap-2">
                <Button
                  size="sm"
                  variant="outline"
                  onClick={() => void handleOpenProject(project.id)}
                  disabled={isBusy}
                  className="flex-1 gap-1.5"
                >
                  <FolderOpen className="h-3.5 w-3.5" />
                  Open
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  className="text-destructive hover:bg-destructive/10 hover:text-destructive"
                  onClick={() => void handleDeleteProject(project.id, project.name)}
                  disabled={isBusy}
                >
                  <Trash2 className="h-3.5 w-3.5" />
                </Button>
              </div>
            </CardContent>
          </Card>
        );
      })}
    </div>
  );

  return (
    <Dialog open={open} onOpenChange={handleDialogOpenChange}>
      <DialogContent className={cn('max-h-[92vh] overflow-hidden p-0', !canClose && '[&>button]:hidden')}>
        <DialogHeader className="border-b border-border/80 px-6 pt-6">
          <div className="flex items-start justify-between gap-3">
            <div className={cn(step === 'start' && 'flex items-start gap-3')}>
              {step === 'start' && (
                <img src="/images/logo.png" alt="BESSER" className="h-7 w-auto shrink-0 brightness-0 dark:invert" />
              )}
              <div>
                <DialogTitle className="text-xl">{currentStepInfo.title}</DialogTitle>
                <DialogDescription>{currentStepInfo.description}</DialogDescription>
              </div>
            </div>
            <Badge variant="secondary" className="shrink-0">
              {currentStepInfo.badge}
            </Badge>
          </div>
        </DialogHeader>

        <input
          ref={importFileInputRef}
          type="file"
          accept=".json,.py"
          className="hidden"
          onChange={handleImportProjectFile}
        />
        <input
          ref={spreadsheetFileInputRef}
          type="file"
          accept=".csv,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv"
          multiple
          className="hidden"
          onChange={handleSpreadsheetFileSelect}
        />

        <div className="max-h-[75vh] overflow-y-auto p-6">
          {step === 'start' && (
            <div className="space-y-5">
              <div className="rounded-2xl border border-border/70 bg-[radial-gradient(120%_130%_at_0%_0%,rgba(14,116,144,0.10)_0%,rgba(16,185,129,0.10)_40%,rgba(248,250,252,0.05)_100%)] p-5">
                <div>
                  <p className="text-sm font-semibold text-foreground">Start Your Modeling Workspace</p>
                  <p className="mt-1 text-xs leading-relaxed text-muted-foreground">
                    BESSER (Better Smart Software Faster) is an open-source model-driven platform for UML design,
                    generation, and deployment. Choose a path below to bootstrap your project quickly.
                  </p>
                </div>
              </div>

              <div className="grid gap-4 md:grid-cols-3">
                <button
                  type="button"
                  onClick={() => setStep('create')}
                  className="rounded-xl border border-border/80 bg-card p-5 text-left shadow-sm transition hover:border-primary/40 hover:bg-primary/5"
                >
                  <div className="mb-3 inline-flex rounded-md bg-primary/10 p-2 text-primary">
                    <Plus className="h-4 w-4" />
                  </div>
                  <p className="text-sm font-semibold">Create Blank</p>
                  <p className="mt-1 text-xs text-muted-foreground">Start from scratch with all editors available.</p>
                </button>

                <button
                  type="button"
                  onClick={() => setStep('spreadsheet')}
                  className="rounded-xl border border-border/80 bg-card p-5 text-left shadow-sm transition hover:border-primary/40 hover:bg-primary/5"
                >
                  <div className="mb-3 inline-flex rounded-md bg-primary/10 p-2 text-primary">
                    <FileSpreadsheet className="h-4 w-4" />
                  </div>
                  <p className="text-sm font-semibold">From Spreadsheet</p>
                  <p className="mt-1 text-xs text-muted-foreground">Auto-generate a class diagram from CSV/XLSX files.</p>
                </button>

                <button
                  type="button"
                  onClick={() => setStep('import')}
                  className="rounded-xl border border-border/80 bg-card p-5 text-left shadow-sm transition hover:border-primary/40 hover:bg-primary/5"
                >
                  <div className="mb-3 inline-flex rounded-md bg-primary/10 p-2 text-primary">
                    <Upload className="h-4 w-4" />
                  </div>
                  <p className="text-sm font-semibold">Import Project</p>
                  <p className="mt-1 text-xs text-muted-foreground">Load an exported `.json` or `.py` project.</p>
                </button>
              </div>

              <div className="rounded-xl border border-border/80 bg-muted/20 p-4">
                <div className="mb-2 flex items-center justify-between">
                  <p className="text-sm font-semibold">Existing Projects</p>
                  <Badge variant="secondary">{projects.length}</Badge>
                </div>
                {projects.length > 0 ? (
                  <div className="space-y-2">
                    {projects.slice(0, 3).map((project) => (
                      <button
                        type="button"
                        key={project.id}
                        className="flex w-full items-center justify-between rounded-md border border-border/70 bg-background px-3 py-2 text-left transition hover:border-primary/40 hover:bg-primary/5"
                        onClick={() => void handleOpenProject(project.id)}
                      >
                        <span className="truncate text-sm">{project.name}</span>
                        <FolderOpen className="h-3.5 w-3.5 text-muted-foreground" />
                      </button>
                    ))}
                    <Button
                      variant="ghost"
                      size="sm"
                      className="mt-1 h-8 px-2 text-xs"
                      onClick={() => setStep('open')}
                    >
                      View all projects
                    </Button>
                  </div>
                ) : (
                  <p className="text-xs text-muted-foreground">No projects yet.</p>
                )}
              </div>

              {!canClose && (
                <div className="rounded-lg border border-amber-300/70 bg-amber-50 px-3 py-2 text-xs text-amber-900 dark:border-amber-800 dark:bg-amber-950/40 dark:text-amber-200">
                  Create, import, or open a project to enter the workspace.
                </div>
              )}
            </div>
          )}

          {step === 'create' && (
            <div className="space-y-5">
              <Button variant="ghost" size="sm" className="h-8 px-2 text-xs" onClick={() => setStep('start')}>
                <ArrowLeft className="mr-1.5 h-3.5 w-3.5" />
                Back
              </Button>

              <div className="grid gap-5 lg:grid-cols-[1.2fr_0.8fr]">
                <Card className="shadow-none">
                  <CardHeader>
                    <CardTitle className="text-lg">Project Details</CardTitle>
                    <CardDescription>Give your workspace a name and description.</CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="space-y-1.5">
                      <Label htmlFor="project-name">Name</Label>
                      <Input
                        id="project-name"
                        value={form.name}
                        onChange={(event) => setForm((previous) => ({ ...previous, name: event.target.value }))}
                        placeholder="My_Modeling_Project"
                      />
                    </div>
                    <div className="space-y-1.5">
                      <Label htmlFor="project-owner">Owner</Label>
                      <Input
                        id="project-owner"
                        value={form.owner}
                        onChange={(event) => setForm((previous) => ({ ...previous, owner: event.target.value }))}
                        placeholder="BESSER User"
                      />
                    </div>
                    <div className="space-y-1.5">
                      <Label htmlFor="project-description">Description</Label>
                      <Textarea
                        id="project-description"
                        value={form.description}
                        onChange={(event) => setForm((previous) => ({ ...previous, description: event.target.value }))}
                        className="min-h-24"
                      />
                    </div>
                    <Button onClick={() => void handleCreateProject()} disabled={isBusy} className="w-full gap-2">
                      <Sparkles className="h-4 w-4" />
                      Create Project
                    </Button>
                  </CardContent>
                </Card>

                <Card className="shadow-none">
                  <CardHeader>
                    <CardTitle className="text-base">Recent Projects</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-2">
                    {projects.slice(0, 5).map((project) => (
                      <button
                        key={project.id}
                        type="button"
                        className="flex w-full items-center justify-between rounded-md border border-border/70 bg-muted/20 px-3 py-2 text-left text-sm transition hover:border-primary/40 hover:bg-primary/5"
                        onClick={() => void handleOpenProject(project.id)}
                      >
                        <span className="truncate">{project.name}</span>
                        <FolderOpen className="h-3.5 w-3.5 text-muted-foreground" />
                      </button>
                    ))}
                    {projects.length === 0 && <p className="text-xs text-muted-foreground">No projects yet.</p>}
                  </CardContent>
                </Card>
              </div>
            </div>
          )}

          {step === 'import' && (
            <div className="space-y-5">
              <Button variant="ghost" size="sm" className="h-8 px-2 text-xs" onClick={() => setStep('start')}>
                <ArrowLeft className="mr-1.5 h-3.5 w-3.5" />
                Back
              </Button>

              <Card className="shadow-none">
                <CardHeader>
                  <CardTitle className="text-lg">Import Project File</CardTitle>
                  <CardDescription>Supported formats: `.json`, `.py`.</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="rounded-lg border border-dashed border-border/80 bg-muted/20 p-5 text-center">
                    <p className="text-sm text-muted-foreground">Select a file and continue editing immediately.</p>
                  </div>
                  <Button
                    variant="outline"
                    onClick={() => importFileInputRef.current?.click()}
                    className="w-full gap-2"
                    disabled={isBusy}
                  >
                    <Upload className="h-4 w-4" />
                    Choose File To Import
                  </Button>
                </CardContent>
              </Card>
            </div>
          )}

          {step === 'spreadsheet' && (
            <div className="space-y-5">
              <Button variant="ghost" size="sm" className="h-8 px-2 text-xs" onClick={() => setStep('start')}>
                <ArrowLeft className="mr-1.5 h-3.5 w-3.5" />
                Back
              </Button>

              <div className="grid gap-5 lg:grid-cols-[1.2fr_0.8fr]">
                <Card className="shadow-none">
                  <CardHeader>
                    <CardTitle className="text-lg">Spreadsheet Input</CardTitle>
                    <CardDescription>Create project metadata and upload source files.</CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="space-y-1.5">
                      <Label htmlFor="spreadsheet-project-name">Name</Label>
                      <Input
                        id="spreadsheet-project-name"
                        value={spreadsheetForm.name}
                        onChange={(event) =>
                          setSpreadsheetForm((previous) => ({ ...previous, name: event.target.value }))
                        }
                        placeholder="My_Spreadsheet_Project"
                      />
                    </div>
                    <div className="space-y-1.5">
                      <Label htmlFor="spreadsheet-project-owner">Owner</Label>
                      <Input
                        id="spreadsheet-project-owner"
                        value={spreadsheetForm.owner}
                        onChange={(event) =>
                          setSpreadsheetForm((previous) => ({ ...previous, owner: event.target.value }))
                        }
                        placeholder="BESSER User"
                      />
                    </div>
                    <div className="space-y-1.5">
                      <Label htmlFor="spreadsheet-project-description">Description</Label>
                      <Textarea
                        id="spreadsheet-project-description"
                        value={spreadsheetForm.description}
                        onChange={(event) =>
                          setSpreadsheetForm((previous) => ({ ...previous, description: event.target.value }))
                        }
                        className="min-h-24"
                      />
                    </div>

                    <div className="rounded-lg border border-dashed border-border/80 bg-muted/20 p-4">
                      <div className="mb-3 flex items-center justify-between">
                        <p className="text-sm font-semibold">Source Files</p>
                        <Badge variant="secondary">{spreadsheetFiles.length}</Badge>
                      </div>
                      <Button
                        variant="outline"
                        className="w-full gap-2"
                        onClick={() => spreadsheetFileInputRef.current?.click()}
                        disabled={isBusy}
                      >
                        <FileSpreadsheet className="h-4 w-4" />
                        Select CSV / XLSX Files
                      </Button>
                      {spreadsheetFiles.length > 0 && (
                        <div className="mt-3 space-y-1.5">
                          {spreadsheetFiles.map((file) => (
                            <div
                              key={`${file.name}-${file.size}`}
                              className="flex items-center justify-between rounded-md border border-border/70 bg-background px-2.5 py-1.5 text-xs"
                            >
                              <span className="truncate">{file.name}</span>
                              <span className="text-muted-foreground">{readableFileSize(file.size)}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    <Button onClick={() => void handleStartFromSpreadsheet()} disabled={isBusy} className="w-full gap-2">
                      <Sparkles className="h-4 w-4" />
                      Create From Spreadsheet
                    </Button>
                  </CardContent>
                </Card>

                <Card className="shadow-none">
                  <CardHeader>
                    <CardTitle className="text-base">How It Works</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-2 text-xs text-muted-foreground">
                    <p>1. Project is created first.</p>
                    <p>2. Spreadsheet files are converted to a class diagram.</p>
                    <p>3. Generated class diagram is imported into the project automatically.</p>
                    <p className="pt-2">
                      Accepted formats: `.csv`, `.xlsx`, `.xls`.
                    </p>
                  </CardContent>
                </Card>
              </div>
            </div>
          )}

          {step === 'open' && (
            <div className="space-y-4">
              <Button variant="ghost" size="sm" className="h-8 px-2 text-xs" onClick={() => setStep('start')}>
                <ArrowLeft className="mr-1.5 h-3.5 w-3.5" />
                Back
              </Button>
              <div className="mb-1 flex items-center justify-between">
                <h3 className="text-base font-semibold">All Projects</h3>
                <Badge variant="secondary">{projects.length}</Badge>
              </div>
              {renderProjectList()}
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
};
